---
title: "CPLN675_midterm"
author: "Jenna Epstein and Kristin Chang"
date: "March 31, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(caret)
library(pscl)
library(plotROC)
library(pROC)
library(sf)
library(tidyverse)
library(knitr)
library(kableExtra)
library(FNN)
library(scales)
library(viridis)


#themes and palettes
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}


```

# Introduction
Text yay.
# Data
Text yay.
## Initial Data
Text here about the fishnet preparation (200x200m cells), and the inundation variable reclassification in ArcGIS pro
## Feature Engineering
Text here to describe process of feature engineering in ArcGIS pro for each one:
** Elevation (mean)
** Flow Accumulation (maximum)
** Distance to nearest stream (archydro workflow)
** Slope (maximum) --- if we don't use this, can still talk about the process
** Distance to Steep Slopes (defining steep slope as at least 10 degrees)
** Land Cover - Impervious Surface (sum of impervious pixels, if we go with that)

```{r, load fishnet for calgary}
# CALGARY: Load Calgary fishnet generated in ArcGIS Pro (200x200m cells).
calgary_fishnet <- st_read("Data_Calgary/Calgary_new/for_R/calgary_fishnet.shp") %>%
st_as_sf() %>% st_transform('EPSG:3780') %>% rename(ID_FISHNET = ID_fishnet)

calgary_fishnet$ID_FISHNET <-as.character(calgary_fishnet$ID_FISHNET)

```
Load the boundary for Calgary, the initial fishnet, and visualize. Note that the inundation raster provided does not cover the whole city, so the study area will be trimmed down later on.
```{r, load boundary for calgary}
calgary_boundary <- st_read("provided_midTermProject_Data/CALGIS_CITYBOUND_LIMIT/CALGIS_CITYBOUND_LIMIT.shp")

calgary_boundary <- calgary_boundary %>% st_transform('EPSG:3780')

ggplot() +
  geom_sf(data=calgary_boundary, fill="grey") +
  geom_sf(data=calgary_fishnet, alpha=0.2) + mapTheme()
```

```{r, load arcgis features for calgary}
# CALGARY: Inundation classification (generated by reclassifying the initial inundation raster, and calculated using zonal statistics (maximum)).
calgary_inundation <- st_read("Data_Calgary/Calgary_new/for_R/cal_inun_max.xls") %>%
  dplyr::select(ID_FISHNET, MAX) %>%
  #dplyr::rename(ID_fishnet = FID) %>%
  dplyr::rename(inundation = MAX)

calgary_inundation$ID_FISHNET <-as.character(calgary_inundation$ID_FISHNET)

calgary_inundation_grid <- left_join(calgary_inundation, calgary_fishnet) %>% st_as_sf()
calgary_fishnet_new <-  calgary_inundation_grid

# CALGARY: Elevation mean (calculated using zonal statistics (mean)).
calgary_elev <- st_read("Data_Calgary/Calgary_new/for_R/cal_elev_mean.xls") %>%
  dplyr::select(ID_FISHNET, MEAN) %>%
  dplyr::rename(elevation_mean = MEAN)

calgary_elev$ID_FISHNET <-as.character(calgary_elev$ID_FISHNET)

calgary_elev_grid <- full_join(calgary_elev, calgary_fishnet_new) %>% st_as_sf()
calgary_fishnet_new <- calgary_elev_grid


```


```{r, streams and flow acc for calgary}
# CALGARY: Stream network, generated using the ArcHydro workflow from the week4 lab in ArcGIS Pro.
calgary_streams <- st_read("HydroData_Calgary_ArcGIS/Data/cal_stream.shp") %>%
  dplyr::rename(ID_stream = arcid) 

calgary_streams_neardist <- st_read("Data_Calgary/Calgary_new/for_R/cal_stream_neardist.xls")  %>%
  dplyr::select(-Rowid, -OBJECTID, -NEAR_FID) %>%
  dplyr::rename(ID_FISHNET = IN_FID) %>%
  dplyr::rename(dist_stream = NEAR_DIST)

##FYI was having trouble calculating distance to line using dist2Line in geosphere package in R, so decided to use the generate near table in ArcGIS to calculate from fishnet to stream. I have no idea if it used the centroid, though.

calgary_streams_neardist$ID_FISHNET <-as.character(calgary_streams_neardist$ID_FISHNET)

calgary_streamneardist_grid <- full_join(calgary_streams_neardist, calgary_fishnet_new) %>% st_as_sf()
calgary_fishnet_new <-  calgary_streamneardist_grid

# CALGARY: flow accumulation max per fishnet cell. Generated using zonal statistics (maximum).
calgary_flowacc <- st_read("Data_Calgary/Calgary_new/for_R/cal_flowacc_max.xls") %>%
  dplyr::rename(flowacc_max = MAX) %>%
  dplyr::select(-Rowid, -COUNT, -AREA, -ZONE.CODE)

calgary_flowacc$ID_FISHNET <-as.character(calgary_flowacc$ID_FISHNET)

calgary_flowacc_grid <- full_join(calgary_flowacc, calgary_fishnet_new) %>%st_as_sf()
calgary_fishnet_new <- calgary_flowacc_grid 
```


```{r, map streams for calgary just to see what's up}
#visualize streams
ggplot() +
  geom_sf(data=calgary_boundary, fill="grey") +
  #geom_sf(data=calgary_fishnet, alpha=0.2) + 
  geom_sf(data=calgary_streams, color="blue") +mapTheme()
```

```{r, parks distance load from arcgis}
# CALGARY: Parks distance - from open data calgary. Used arcgis pro to create a near distance table.

calgary_parks_neardist <- st_read("Data_Calgary/Calgary_new/for_R/cal_parksfeat_near.xls")  %>%
  dplyr::select(-Rowid, -OBJECTID, -NEAR_FID) %>%
  dplyr::rename(ID_FISHNET = IN_FID) %>%
  dplyr::rename(dist_parks = NEAR_DIST)

calgary_parks_neardist$ID_FISHNET <-as.character(calgary_parks_neardist$ID_FISHNET)

calgary_parks_neardist_grid <- full_join(calgary_parks_neardist, calgary_fishnet_new) %>% st_as_sf()
calgary_fishnet_new <-  calgary_parks_neardist_grid
```
```{r, import shapefile of hydrology features}
#shapefile import
calgary_hydro <- st_read("Data_Calgary/Calgary_new/for_R/Hydrology/hydrology_features.shp") %>%
  st_transform(st_crs(calgary_fishnet_new))

#visualize hydrology features - more extensive than what the stream network from ArcGIS provided
ggplot() +
  geom_sf(data=calgary_boundary, fill="grey") +
  #geom_sf(data=calgary_fishnet, alpha=0.2) + 
  geom_sf(data=calgary_hydro, color="blue") +mapTheme()

```
```{r, number of hydrology feature intersections per fishnet cell}
calgary_fishnet_new <- calgary_fishnet_new %>% mutate(n_hydro_int = lengths(st_intersects(calgary_fishnet_new, calgary_hydro)))
```


```{r, slope max and distance to steep slopes for calgary}
# CALGARY: Slope max per fishnet cell. Generated using zonal statistics (max).
calgary_slope <- st_read("Data_Calgary/Calgary_new/for_R/cal_slope_max.xls") %>%
  dplyr::rename(slope_max = MAX) %>%
  dplyr::select(-Rowid, -COUNT, -AREA, -ZONE.CODE)

calgary_slope$ID_FISHNET <-as.character(calgary_slope$ID_FISHNET)

calgary_slope_grid <- full_join(calgary_slope, calgary_fishnet_new) %>% st_as_sf()
calgary_fishnet_new <- calgary_slope_grid

# CALGARY: Distance to steep slopes per fishnet cell. Generated using near table, near distance.
calgary_steepslope_dist <- st_read("Data_Calgary/Calgary_new/for_R/cal_steepslope_dist.xls")  %>%
  dplyr::select(-Rowid, -OBJECTID, -NEAR_FID) %>%
  dplyr::rename(ID_FISHNET = IN_FID) %>%
  dplyr::rename(steepslope_dist = NEAR_DIST)

calgary_steepslope_dist$ID_FISHNET <-as.character(calgary_steepslope_dist$ID_FISHNET)

calgary_steepslope_dist_grid <- full_join(calgary_steepslope_dist, calgary_fishnet_new) %>%st_as_sf()
calgary_fishnet_new <- calgary_steepslope_dist_grid 

```

```{r, impervious land cover sum  for calgary}
# CALGARY: majority land cover type per fishnet cell. Reclassified the data by land cover category 1-17, converted it to a raster, and used zonal statistics (majority).

calgary_impervious_sum <- st_read("Data_Calgary/Calgary_new/for_R/cal_lcimp_sumt.xls") %>%
  dplyr::rename(imperv_pixels_sum = SUM) %>%
  dplyr::select(-Rowid, -COUNT, -AREA, -ZONE.CODE)

calgary_impervious_sum$ID_FISHNET <-as.character(calgary_impervious_sum$ID_FISHNET)

calgary_impervious_sum_grid <- full_join(calgary_impervious_sum, calgary_fishnet_new) %>% st_as_sf()

calgary_impervious_sum_grid[is.na(calgary_impervious_sum_grid)] = 0

calgary_fishnet_new <- calgary_impervious_sum_grid

```


Talk about trimming the fishnet down by doing a select-by-centroids approach.
```{r, select fishnet cells by centroid}
# Centroid-in-polygon join to see which cells have their centroid in the calgary boundary
calgary_selectCentroids <-
  st_centroid(calgary_fishnet_new)[calgary_boundary,] %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(calgary_fishnet_new, ID_FISHNET)) %>%
  st_sf()

calgary_fishnet_final <- calgary_selectCentroids

```


```{r}
ggplot() + 
  geom_sf(data=calgary_fishnet_final, aes(fill=as.factor(inundation)), color=NA) +
  scale_fill_manual(values = c("navy", "darkgreen"),
                    labels = c("yes","no"),
                    name = "Inundation") +
  labs(title="Inundation in Calgary", subtitle = "By way of the fishnet") +
  geom_sf(data=calgary_boundary, color="black", fill=NA)+
  mapTheme()

```

```{r, convert to numeric}
calgary_fishnet_final <- calgary_fishnet_final %>%
  dplyr::select(-Shape_Leng, -Shape_Area)

calgary_fishnet_final$inundation <-as.numeric(as.character(calgary_fishnet_final$inundation))
calgary_fishnet_final$slope_max <-as.numeric(as.character(calgary_fishnet_final$slope_max))
calgary_fishnet_final$flowacc_max <-as.numeric(as.character(calgary_fishnet_final$flowacc_max))
calgary_fishnet_final$elevation_mean <-as.numeric(as.character(calgary_fishnet_final$elevation_mean))
calgary_fishnet_final$imperv_pixels_sum <-as.numeric(as.character(calgary_fishnet_final$imperv_pixels_sum))
calgary_fishnet_final$dist_stream <-as.numeric(as.character(calgary_fishnet_final$dist_stream))
calgary_fishnet_final$n_hydro_int <-as.numeric(as.character(calgary_fishnet_final$n_hydro_int))
calgary_fishnet_final$dist_parks <-as.numeric(as.character(calgary_fishnet_final$dist_parks))
calgary_fishnet_final$steepslope_dist <-as.numeric(as.character(calgary_fishnet_final$steepslope_dist))
```

## Feature Engineering: Maps of Independent Variables
```{r}
#distance to streams
ggplot() +
  geom_sf(data = calgary_fishnet_final, aes(fill = dist_stream), color=NA) +
  scale_fill_viridis()+
  labs(title = "Distance to Streams", fill="Distance \n(meters)") + mapTheme()
```
```{r}
#number of hydrology feature intersections
ggplot() +
  geom_sf(data = calgary_fishnet_final, aes(fill = n_hydro_int), color=NA) +
  scale_fill_viridis()+
  labs(title = "Hydrology Intersections", fill="Number") + mapTheme()
```

```{r}
ggplot() +
  geom_sf(data = calgary_fishnet_final, aes(fill = flowacc_max), color=NA) +
  scale_fill_viridis()+
  labs(title = "Flow Accumulation, Maximum", fill="Max. Acc") + mapTheme()
```
```{r}
ggplot() +
  geom_sf(data = calgary_fishnet_final, aes(fill = elevation_mean), color=NA) +
  scale_fill_viridis()+
  labs(title = "Elevation (mean)", fill="Elevation Mean \n(meters)") + mapTheme()
```
```{r}
ggplot() +
  geom_sf(data = calgary_fishnet_final, aes(fill = steepslope_dist), color=NA) +
  scale_fill_viridis()+
  labs(title = "Distance to Steep Slopes", fill="Distance \n(meters)", subtitle = "Steep slopes defined as at least 10 degrees") + mapTheme()
```



```{r}

#writing what I have so far to a .csv also in github, so you can also just load this back in and do a join to the fishnet shapefile (using ID_fishnet as the joiner)


#st_write(calgary_fishnet_final, "calgary_fishnet_final_new.csv")

```
## Modeling

```{r}
inundationPlotVariables <- 
  calgary_fishnet_final %>% st_drop_geometry()
```

```{r}
# plotting independent variables for elevation_mean and slope_max
calgary_fishnet_variables <- inundationPlotVariables %>%
  dplyr::select(inundation, elevation_mean, steepslope_dist, dist_stream, dist_parks, slope_max) %>%
  gather(key, value, elevation_mean:slope_max)%>%
   mutate(value = ifelse(key == "slope_max", value*100, value))


ggplot(calgary_fishnet_variables, aes(as.factor(inundation), value, fill=as.factor(inundation))) + 
    geom_bar(stat = "identity")+
    facet_wrap(~key) +
    scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("dodgerblue4", "darkgreen"),
                    labels = c("Not Inundated","Inundated"),
                    name = "")   + labs(x="Inundation", y="Value")
```

```{r}

#plotting these again, but this time using stat="summary" and mean for the function. also, scaling slope to see if there is a discernable difference. 
calgary_fishnet_variables <- inundationPlotVariables %>%
  dplyr::select(inundation, elevation_mean, steepslope_dist, dist_stream, dist_parks, slope_max) %>%
  gather(key, value, elevation_mean:slope_max) %>%
   mutate(value = ifelse(key == "slope_max", value*100, value))


ggplot(calgary_fishnet_variables, aes(as.factor(inundation), value, fill=as.factor(inundation))) + 
    geom_bar(stat = "summary", fun="mean") +
    facet_wrap(~key) +
    scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("dodgerblue4", "darkgreen"),
                    labels = c("Not Inundated","Inundated"),
                    name = "")   + labs(x="Inundation", y="Mean") +plotTheme()
```


```{r}
# flow accumulation max, visualizing separately
calgary_fishnet_variable_imperv <- inundationPlotVariables %>%
  dplyr::select(inundation, flowacc_max) %>%
  gather(key, value, flowacc_max)


ggplot(calgary_fishnet_variable_imperv, aes(as.factor(inundation), value, fill=as.factor(inundation))) + 
    geom_bar(stat = "identity")+
    facet_wrap(~key) +
      scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("dodgerblue4", "darkgreen"),
                    labels = c("Not Inundated","Inundated"),
                    name = "")   + labs(x="Inundation", y="Value") +plotTheme()
```

```{r}
#imperv surface was warping the scaling, so visualizing separately
calgary_fishnet_variable_imperv <- inundationPlotVariables %>%
  dplyr::select(inundation, imperv_pixels_sum) %>%
  gather(key, value, imperv_pixels_sum)


ggplot(calgary_fishnet_variable_imperv, aes(as.factor(inundation), value, fill=as.factor(inundation))) + 
    geom_bar(stat = "identity")+
    facet_wrap(~key) +
      scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("dodgerblue4", "darkgreen"),
                    labels = c("Not Inundated","Inundated"),
                    name = "")   + labs(x="Inundation", y="Value") +plotTheme()
```
```{r}
# number of hydro intersections, visualizing separately
calgary_fishnet_variable_nhydroint <- inundationPlotVariables %>%
  dplyr::select(inundation, n_hydro_int) %>%
  gather(key, value, n_hydro_int)


ggplot(calgary_fishnet_variable_nhydroint, aes(as.factor(inundation), value, fill=as.factor(inundation))) + 
    geom_bar(stat = "identity")+
    facet_wrap(~key) +
      scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("dodgerblue4", "darkgreen"),
                    labels = c("Not Inundated","Inundated"),
                    name = "")   + labs(x="Inundation", y="Value") +plotTheme()
```


```{r}
set.seed(3456)
trainIndex <- createDataPartition(calgary_fishnet_final$inundation, p = .70,
                                  list = FALSE,
                                  times = 1)
calgaryTrain <- calgary_fishnet_final[ trainIndex,]
calgaryTest  <- calgary_fishnet_final[-trainIndex,]
```

```{r}
calgaryModel <- glm(inundation ~ ., family="binomial"(link="logit"),
                  data=(calgaryTrain) %>% as.data.frame() %>% dplyr::select(-ID_FISHNET, -geometry, -slope_max, -imperv_pixels_sum))


```

```{r}
summary(calgaryModel)
```
```{r}
library(jtools)
summ(calgaryModel)

```

```{r}
classProbs <- predict(calgaryModel, calgaryTest, type="response")

hist(classProbs)
```

```{r}
testProbs <- data.frame(obs = as.numeric(calgaryTest$inundation),
                        pred = classProbs)

ggplot(testProbs, aes(x = pred, fill=as.factor(obs))) + geom_density() +
  facet_grid(obs ~ .) + xlab("Probability") + geom_vline(xintercept = .5) +
  scale_fill_manual(values = c("dodgerblue4", "darkgreen"),
                      labels = c("Not Inundated","Inundated")) +
                      labs(title = "Distribution of Probabilities") + plotTheme()
```

```{r}
#changed the threshold to 0.4
testProbs$predClass  = ifelse(testProbs$pred > .4 ,1,0)

xtab.regCalgary <- caret::confusionMatrix(reference = as.factor(testProbs$obs), 
                       data = as.factor(testProbs$predClass), 
                       positive = "1")
```

```{r}

as.matrix(xtab.regCalgary) %>% kable(caption = "Confusion Matrix") %>% kable_styling("striped", full_width = T, font_size = 14, position = "left")
```
```{r}
as.matrix(xtab.regCalgary, what="classes") %>% kable(caption = "Confusion Matrix - Statistics") %>% kable_styling(font_size = 14, full_width = T,
                bootstrap_options = c("striped", "hover"))
```

```{r}
ggplot(testProbs, aes(d = obs, m = pred)) + 
  geom_roc(n.cuts = 50, labels = FALSE) + 
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1.5, color = 'grey') 
```
```{r}
auc_calgary <- auc(testProbs$obs, testProbs$pred)
print(auc_calgary)
```


```{r}
#convert inundation to factor
calgary_fishnet_final$inundation <-as.factor(as.character(calgary_fishnet_final$inundation))


```

```{r}
ctrl <- trainControl(method = "cv", 
                     number = 100,
                     savePredictions = TRUE)

cvFit_calgaryReg <- train(as.factor(inundation) ~ ., data = calgary_fishnet_final %>% 
                            as.data.frame() %>%
                            select(-ID_FISHNET, -geometry, -slope_max, -imperv_pixels_sum),
                          method="glm", family="binomial", trControl=ctrl)

cvFit_calgaryReg
```

```{r}
ggplot(as.data.frame(cvFit_calgaryReg$resample), aes(Accuracy)) + 
  geom_histogram() +
  scale_x_continuous(limits = c(0, 1)) +
  labs(x="Accuracy",
       y="Count") +plotTheme()
```
```{r}
allPredictions <- 
  predict(cvFit_calgaryReg, calgary_fishnet_final, type="prob")[,2]
  
calgary_fishnet_final_preds <- calgary_fishnet_final %>%
  cbind(calgary_fishnet_final,allPredictions) %>%
  mutate(allPredictions = round(allPredictions * 100)) 
```

```{r}
ggplot() + 
    geom_sf(data=calgary_fishnet_final_preds, aes(fill=factor(ntile(allPredictions,5))), colour=NA) +
    scale_fill_manual(values = c("#edf8fb","#b3cde3","#8c96c6","#8856a7","#810f7c"),
                      labels=as.character(quantile(calgary_fishnet_final_preds$allPredictions,
                                                 c(0.1,.2,.4,.6,.8),na.rm=T)),
                      name="Predicted\nProbabilities(%)\n(Quintile\nBreaks)") +
  mapTheme() +
  labs(title="")
```
## still workin on thresholds, this function needs updated variables to match what we have goin on

```{r}
# iterateThresholds function
iterateThresholds <- function(data, group) {
   group <- enquo(group)
  x = .01
  all_prediction <- data.frame()
  while (x <= 1) {

  this_prediction <-
      testProbs %>%
      mutate(predOutcome = ifelse(Probs > x, 1, 0)) %>%
         group_by(!!group) %>%
      dplyr::count(predOutcome, Outcome) %>%
      dplyr::summarize(sum_TN = sum(n[predOutcome==0 & Outcome==0]),
                sum_TP = sum(n[predOutcome==1 & Outcome==1]),
                sum_FN = sum(n[predOutcome==0 & Outcome==1]),
                sum_FP = sum(n[predOutcome==1 & Outcome==0]),
            total=sum(n)) %>%
    mutate(True_Positive = sum_TP / total,
         True_Negative = sum_TN / total,
         False_Negative = sum_FN / total,
         False_Positive = sum_FP / total,
         Accuracy = (sum_TP + sum_TN) / total, Threshold = x)

  all_prediction <- rbind(all_prediction, this_prediction)
  x <- x + .01
  }
return(all_prediction)
}
```

```{r}
whichThreshold <- iterateThresholds(testProbs)

allThresholds<-kable(whichThreshold) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)%>%
  scroll_box(width = "100%", height = "500px")

allThresholds
```

